{"ast":null,"code":"var Sequence = require('./Sequence');\n\nvar Util = require('util');\n\nvar Packets = require('../packets');\n\nvar Auth = require('../Auth');\n\nvar ClientConstants = require('../constants/client');\n\nmodule.exports = Handshake;\nUtil.inherits(Handshake, Sequence);\n\nfunction Handshake(options, callback) {\n  Sequence.call(this, options, callback);\n  options = options || {};\n  this._config = options.config;\n  this._handshakeInitializationPacket = null;\n}\n\nHandshake.prototype.determinePacket = function determinePacket(firstByte, parser) {\n  if (firstByte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (!this._handshakeInitializationPacket) {\n    return Packets.HandshakeInitializationPacket;\n  }\n\n  if (firstByte === 0xfe) {\n    return parser.packetLength() === 1 ? Packets.UseOldPasswordPacket : Packets.AuthSwitchRequestPacket;\n  }\n\n  return undefined;\n};\n\nHandshake.prototype['AuthSwitchRequestPacket'] = function (packet) {\n  var name = packet.authMethodName;\n  var data = Auth.auth(name, packet.authMethodData, {\n    password: this._config.password\n  });\n\n  if (data !== undefined) {\n    this.emit('packet', new Packets.AuthSwitchResponsePacket({\n      data: data\n    }));\n  } else {\n    var err = new Error('MySQL is requesting the ' + name + ' authentication method, which is not supported.');\n    err.code = 'UNSUPPORTED_AUTH_METHOD';\n    err.fatal = true;\n    this.end(err);\n  }\n};\n\nHandshake.prototype['HandshakeInitializationPacket'] = function (packet) {\n  this._handshakeInitializationPacket = packet;\n  this._config.protocol41 = packet.protocol41;\n  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\n\n  if (this._config.ssl) {\n    if (!serverSSLSupport) {\n      var err = new Error('Server does not support secure connection');\n      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\n      err.fatal = true;\n      this.end(err);\n      return;\n    }\n\n    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\n    this.emit('packet', new Packets.SSLRequestPacket({\n      clientFlags: this._config.clientFlags,\n      maxPacketSize: this._config.maxPacketSize,\n      charsetNumber: this._config.charsetNumber\n    }));\n    this.emit('start-tls');\n  } else {\n    this._sendCredentials();\n  }\n};\n\nHandshake.prototype._tlsUpgradeCompleteHandler = function () {\n  this._sendCredentials();\n};\n\nHandshake.prototype._sendCredentials = function () {\n  var packet = this._handshakeInitializationPacket;\n  this.emit('packet', new Packets.ClientAuthenticationPacket({\n    clientFlags: this._config.clientFlags,\n    maxPacketSize: this._config.maxPacketSize,\n    charsetNumber: this._config.charsetNumber,\n    user: this._config.user,\n    database: this._config.database,\n    protocol41: packet.protocol41,\n    scrambleBuff: packet.protocol41 ? Auth.token(this._config.password, packet.scrambleBuff()) : Auth.scramble323(packet.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['UseOldPasswordPacket'] = function () {\n  if (!this._config.insecureAuth) {\n    var err = new Error('MySQL server is requesting the old and insecure pre-4.1 auth mechanism. ' + 'Upgrade the user password or use the {insecureAuth: true} option.');\n    err.code = 'HANDSHAKE_INSECURE_AUTH';\n    err.fatal = true;\n    this.end(err);\n    return;\n  }\n\n  this.emit('packet', new Packets.OldPasswordPacket({\n    scrambleBuff: Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['ErrorPacket'] = function (packet) {\n  var err = this._packetToError(packet, true);\n\n  err.fatal = true;\n  this.end(err);\n};","map":{"version":3,"names":["Sequence","require","Util","Packets","Auth","ClientConstants","module","exports","Handshake","inherits","options","callback","call","_config","config","_handshakeInitializationPacket","prototype","determinePacket","firstByte","parser","ErrorPacket","HandshakeInitializationPacket","packetLength","UseOldPasswordPacket","AuthSwitchRequestPacket","undefined","packet","name","authMethodName","data","auth","authMethodData","password","emit","AuthSwitchResponsePacket","err","Error","code","fatal","end","protocol41","serverSSLSupport","serverCapabilities1","CLIENT_SSL","ssl","clientFlags","SSLRequestPacket","maxPacketSize","charsetNumber","_sendCredentials","_tlsUpgradeCompleteHandler","ClientAuthenticationPacket","user","database","scrambleBuff","token","scramble323","insecureAuth","OldPasswordPacket","_packetToError"],"sources":["C:/Users/ZCJ/Desktop/internshipsysrem/node_modules/mysql/lib/protocol/sequences/Handshake.js"],"sourcesContent":["var Sequence        = require('./Sequence');\nvar Util            = require('util');\nvar Packets         = require('../packets');\nvar Auth            = require('../Auth');\nvar ClientConstants = require('../constants/client');\n\nmodule.exports = Handshake;\nUtil.inherits(Handshake, Sequence);\nfunction Handshake(options, callback) {\n  Sequence.call(this, options, callback);\n\n  options = options || {};\n\n  this._config                        = options.config;\n  this._handshakeInitializationPacket = null;\n}\n\nHandshake.prototype.determinePacket = function determinePacket(firstByte, parser) {\n  if (firstByte === 0xff) {\n    return Packets.ErrorPacket;\n  }\n\n  if (!this._handshakeInitializationPacket) {\n    return Packets.HandshakeInitializationPacket;\n  }\n\n  if (firstByte === 0xfe) {\n    return (parser.packetLength() === 1)\n      ? Packets.UseOldPasswordPacket\n      : Packets.AuthSwitchRequestPacket;\n  }\n\n  return undefined;\n};\n\nHandshake.prototype['AuthSwitchRequestPacket'] = function (packet) {\n  var name = packet.authMethodName;\n  var data = Auth.auth(name, packet.authMethodData, {\n    password: this._config.password\n  });\n\n  if (data !== undefined) {\n    this.emit('packet', new Packets.AuthSwitchResponsePacket({\n      data: data\n    }));\n  } else {\n    var err   = new Error('MySQL is requesting the ' + name + ' authentication method, which is not supported.');\n    err.code  = 'UNSUPPORTED_AUTH_METHOD';\n    err.fatal = true;\n    this.end(err);\n  }\n};\n\nHandshake.prototype['HandshakeInitializationPacket'] = function(packet) {\n  this._handshakeInitializationPacket = packet;\n\n  this._config.protocol41 = packet.protocol41;\n\n  var serverSSLSupport = packet.serverCapabilities1 & ClientConstants.CLIENT_SSL;\n\n  if (this._config.ssl) {\n    if (!serverSSLSupport) {\n      var err = new Error('Server does not support secure connection');\n\n      err.code = 'HANDSHAKE_NO_SSL_SUPPORT';\n      err.fatal = true;\n\n      this.end(err);\n      return;\n    }\n\n    this._config.clientFlags |= ClientConstants.CLIENT_SSL;\n    this.emit('packet', new Packets.SSLRequestPacket({\n      clientFlags   : this._config.clientFlags,\n      maxPacketSize : this._config.maxPacketSize,\n      charsetNumber : this._config.charsetNumber\n    }));\n    this.emit('start-tls');\n  } else {\n    this._sendCredentials();\n  }\n};\n\nHandshake.prototype._tlsUpgradeCompleteHandler = function() {\n  this._sendCredentials();\n};\n\nHandshake.prototype._sendCredentials = function() {\n  var packet = this._handshakeInitializationPacket;\n  this.emit('packet', new Packets.ClientAuthenticationPacket({\n    clientFlags   : this._config.clientFlags,\n    maxPacketSize : this._config.maxPacketSize,\n    charsetNumber : this._config.charsetNumber,\n    user          : this._config.user,\n    database      : this._config.database,\n    protocol41    : packet.protocol41,\n    scrambleBuff  : (packet.protocol41)\n      ? Auth.token(this._config.password, packet.scrambleBuff())\n      : Auth.scramble323(packet.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['UseOldPasswordPacket'] = function() {\n  if (!this._config.insecureAuth) {\n    var err = new Error(\n      'MySQL server is requesting the old and insecure pre-4.1 auth mechanism. ' +\n      'Upgrade the user password or use the {insecureAuth: true} option.'\n    );\n\n    err.code = 'HANDSHAKE_INSECURE_AUTH';\n    err.fatal = true;\n\n    this.end(err);\n    return;\n  }\n\n  this.emit('packet', new Packets.OldPasswordPacket({\n    scrambleBuff: Auth.scramble323(this._handshakeInitializationPacket.scrambleBuff(), this._config.password)\n  }));\n};\n\nHandshake.prototype['ErrorPacket'] = function(packet) {\n  var err = this._packetToError(packet, true);\n  err.fatal = true;\n  this.end(err);\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}